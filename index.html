<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI éš¨èº«å£è­¯æ©Ÿ (ä¿®å¾©ç‰ˆ)</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --btn-blue: #0a84ff;
            --btn-red: #ff453a;
            --text: #ffffff;
            --gray: #8e8e93;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
            color: var(--text);
            overflow: hidden;
            touch-action: manipulation;
            -webkit-user-select: none; user-select: none;
        }

        /* é ‚éƒ¨å°èˆª (ä¿®å¾©ï¼šåŠ å…¥è¨­å®šæŒ‰éˆ•) */
        .navbar {
            padding: 10px 15px; background: var(--bg-color);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 0.5px solid #333; height: 44px;
        }

        .status-text { font-size: 15px; font-weight: 600; color: var(--gray); }

        .btn-gear {
            background: none; border: none; font-size: 20px; cursor: pointer;
            padding: 5px; opacity: 0.7;
        }

        /* è¢å¹•å°è©±å€ */
        .screen {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .msg {
            padding: 14px 18px; border-radius: 20px; max-width: 85%;
            font-size: 20px; line-height: 1.4; animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        @keyframes pop { from{transform:scale(0.9);opacity:0;} to{transform:scale(1);opacity:1;} }

        .msg-me { align-self: flex-end; background: var(--btn-blue); color: #fff; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background: #2c2c2e; color: #fff; border-bottom-left-radius: 4px; }

        .translation {
            font-size: 22px; font-weight: 700; margin-top: 8px;
            color: #ffd60a; 
            border-top: 1px solid rgba(255,255,255,0.15);
            padding-top: 8px;
        }

        /* æŒ‰éˆ•æ§åˆ¶å€ */
        .controls {
            height: 260px; background: var(--card-bg);
            display: flex; justify-content: space-evenly; align-items: center;
            padding-bottom: 40px; border-top-left-radius: 24px; border-top-right-radius: 24px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        .tap-btn {
            width: 110px; height: 110px; border-radius: 50%;
            background: #3a3a3c;
            color: white; font-size: 22px; font-weight: 700;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 0.2s; cursor: pointer; -webkit-tap-highlight-color: transparent;
            position: relative;
        }
        
        .tap-btn::after {
            content: ''; position: absolute; top: -6px; left: -6px; right: -6px; bottom: -6px;
            border-radius: 50%; border: 3px solid #3a3a3c; opacity: 0.5;
        }

        .tap-btn span.sub { font-size: 13px; color: #aaa; margin-top: 4px; font-weight: 400; }

        .tap-btn.recording { transform: scale(1.1); }
        .btn-tw.recording { background: var(--btn-blue); box-shadow: 0 0 30px rgba(10, 132, 255, 0.4); }
        .btn-tw.recording::after { border-color: var(--btn-blue); }
        
        .btn-jp.recording { background: var(--btn-red); box-shadow: 0 0 30px rgba(255, 69, 58, 0.4); }
        .btn-jp.recording::after { border-color: var(--btn-red); }

        /* Modal */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); z-index: 999; display: flex;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
            display: none; /* é è¨­éš±è— */
        }
        .modal-box { background: #2c2c2e; padding: 30px; border-radius: 20px; width: 80%; max-width: 320px; text-align: center; border: 1px solid #444; }
        input { width: 100%; padding: 14px; margin: 20px 0; font-size: 16px; background: #1c1c1e; color: #fff; border: 1px solid #444; border-radius: 12px; box-sizing: border-box; text-align: center;}
        button { padding: 14px 0; width: 100%; font-size: 16px; background: var(--btn-blue); color: white; border: none; border-radius: 12px; font-weight: bold; }

    </style>
</head>
<body>

    <div class="navbar">
        <div style="width: 30px;"></div> <div class="status-text" id="statusText">Ready</div>
        <button class="btn-gear" onclick="openModal()">âš™ï¸</button>
    </div>

    <div class="screen" id="screen">
        <div style="text-align:center; color:#444; margin-top:auto; padding-bottom:30px; font-size:14px;">
            å¦‚æœç„¡æ³•ä½¿ç”¨ï¼Œè«‹é»å³ä¸Šè§’ âš™ï¸ é‡è¨­ Key
        </div>
    </div>

    <div class="controls">
        <div id="btnJP" class="tap-btn btn-jp">
            <span>JP</span>
            <span class="sub">å°æ–¹</span>
        </div>
        <div id="btnTW" class="tap-btn btn-tw">
            <span>TW</span>
            <span class="sub">æˆ‘</span>
        </div>
    </div>

    <div id="keyModal" class="modal">
        <div class="modal-box">
            <h3 style="color:#fff; margin:0; font-size: 20px;">è¨­å®š Key</h3>
            <p style="color:#888; font-size:13px; margin-top:8px;">é‡æ–°æ•´ç†å¾Œè«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢º</p>
            <input type="password" id="apiKey" placeholder="è²¼ä¸Š API Key">
            <button onclick="saveKey()">å„²å­˜ä¸¦é‡é€£</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let genAI, model;
        let recognition;
        let isRecording = false;
        let btnLock = false;
        let currentBtn = null;
        let audioCtx = null; 

        // --- åˆå§‹åŒ– & Key ç®¡ç† ---
        window.openModal = () => {
            document.getElementById('keyModal').style.display = 'flex';
        };

        window.saveKey = () => {
            const key = document.getElementById('apiKey').value.trim();
            if(key) {
                localStorage.setItem('gemini_mobile_key_v3', key);
                initAI(key);
                document.getElementById('keyModal').style.display = 'none';
            }
        };

        // è‡ªå‹•è¼‰å…¥ Key
        const savedKey = localStorage.getItem('gemini_mobile_key_v3');
        if(savedKey) {
            document.getElementById('apiKey').value = savedKey;
            initAI(savedKey);
        } else {
            openModal(); // æ²’ Key å°±å½ˆçª—
        }

        function initAI(key) {
            try {
                genAI = new GoogleGenerativeAI(key);
                model = genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash",
                    systemInstruction: "ä½ æ˜¯ä¸€å€‹å°ˆæ¥­å£è­¯å“¡ã€‚å°‡è¼¸å…¥ç¿»è­¯æˆç›®æ¨™èªè¨€ã€‚è¦å‰‡ï¼šç›´æ¥è¼¸å‡ºç¿»è­¯çµæœã€‚"
                });
                updateStatus("Ready");
            } catch(e) { 
                updateStatus("Key Error", "#ff453a");
                openModal(); // Key éŒ¯äº†å°±å½ˆçª—
            }
        }

        function updateStatus(text, color = "#8e8e93") {
            const el = document.getElementById('statusText');
            el.innerText = text;
            el.style.color = color;
        }

        // --- æç¤ºéŸ³ ---
        function playBeep() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime); 
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1); 
        }

        // --- æ ¸å¿ƒèªéŸ³é‚è¼¯ ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        function setupBtn(id, lang, type) {
            const btn = document.getElementById(id);
            btn.onclick = (e) => {
                e.preventDefault();
                if(btnLock) return;

                // å–šé†’ TTS
                window.speechSynthesis.cancel(); 
                const empty = new SpeechSynthesisUtterance('');
                window.speechSynthesis.speak(empty);

                if (isRecording) {
                    if(recognition) recognition.stop();
                    return;
                }
                startRecording(btn, lang, type);
            };
        }

        function startRecording(btn, lang, type) {
            if(!SpeechRecognition) return;

            if(recognition) { try { recognition.abort(); } catch(e){} }

            playBeep();
            btnLock = true;
            setTimeout(() => btnLock = false, 300);

            recognition = new SpeechRecognition();
            
            // iOS æ—¥æ–‡ç›¸å®¹è¨­å®š
            if (lang === 'ja-JP') {
                recognition.lang = 'ja'; 
                recognition.interimResults = false; 
                recognition.maxAlternatives = 1;
            } else {
                recognition.lang = lang;
                recognition.interimResults = true;
            }
            
            recognition.continuous = false; 

            // å»ºç«‹æ°£æ³¡
            let tempMsgDiv = document.createElement('div');
            tempMsgDiv.className = `msg ${type === 'tw' ? 'msg-me' : 'msg-other'}`;
            tempMsgDiv.innerHTML = `<span style="opacity:0.6;">...</span>`; 
            const screen = document.getElementById('screen');
            screen.appendChild(tempMsgDiv);
            screen.scrollTop = screen.scrollHeight;

            recognition.onstart = () => {
                isRecording = true;
                currentBtn = btn;
                btn.classList.add('recording');
                updateStatus(lang === 'ja-JP' ? "Listening (JP)..." : "Listening (TW)...", "#0a84ff");
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                
                if (interimTranscript) tempMsgDiv.innerHTML = `<span style="opacity:0.7">${interimTranscript}</span>`;
                if (finalTranscript) {
                    tempMsgDiv.innerHTML = finalTranscript;
                    processText(finalTranscript, type, tempMsgDiv);
                }
            };

            recognition.onend = () => { stopRecording(); };
            
            recognition.onerror = (e) => {
                stopRecording();
                if(e.error === 'aborted' || e.error === 'no-speech') {
                    if(tempMsgDiv.innerText === '...') tempMsgDiv.remove();
                    return;
                }
                // éŒ¯èª¤è™•ç†
                if(e.error === 'not-allowed') {
                    updateStatus("ç„¡éº¥å…‹é¢¨æ¬Šé™", "#ff453a");
                } else {
                    updateStatus("é‡è©¦ä¸­...", "#ff453a");
                }
                if(tempMsgDiv.innerText === '...') tempMsgDiv.remove();
            };

            try { recognition.start(); } catch(e) { btnLock = false; }
        }

        function stopRecording() {
            isRecording = false;
            if(currentBtn) currentBtn.classList.remove('recording');
            currentBtn = null;
            updateStatus("Ready");
        }

        // --- ç¿»è­¯èˆ‡æœ—è®€ ---
        async function processText(text, type, msgDiv) {
            if(!text.trim()) return;
            
            updateStatus("Translating...", "#ffd60a");
            
            msgDiv.innerHTML += `<div class="translation"><span style="font-size:16px">...</span></div>`;
            const transEl = msgDiv.querySelector('.translation');
            document.getElementById('screen').scrollTop = document.getElementById('screen').scrollHeight;
            
            const target = type === 'tw' ? 'Japanese' : 'Traditional Chinese';
            const speakLang = type === 'tw' ? 'ja-JP' : 'zh-TW';
            
            try {
                if(!model) throw new Error("API Key unset");
                const result = await model.generateContent(`Translate to ${target}: "${text}"`);
                const transText = result.response.text();
                
                transEl.innerHTML = `${transText} <span style="font-size:16px; opacity:0.7;">ğŸ”Š</span>`;
                updateStatus("Done");
                
                speak(transText, speakLang);
                
                msgDiv.onclick = () => {
                    speak(transText, speakLang);
                    msgDiv.style.opacity = '0.7';
                    setTimeout(() => msgDiv.style.opacity = '1', 100);
                };

            } catch(e) { 
                transEl.innerText = "Error";
                updateStatus("Check Key", "#ff453a");
                openModal(); // å¦‚æœ API å ±éŒ¯ï¼Œè‡ªå‹•å½ˆå‡ºè¨­å®šçª—
            }
        }

        function speak(text, lang) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang;
            window.speechSynthesis.speak(u);
        }

        setupBtn('btnTW', 'cmn-Hant-TW', 'tw');
        setupBtn('btnJP', 'ja-JP', 'jp');

    </script>
</body>
</html>