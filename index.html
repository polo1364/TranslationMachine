<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI é›™èªå£è­¯æ©Ÿ (æ‰“å­—ä¿®å¾©ç‰ˆ)</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --btn-blue: #007aff;
            --btn-red: #ff3b30;
            --btn-purple: #af52de;
            --text-main: #ffffff;
            --text-sub: #8e8e93;
            --bubble-me: #007aff;
            --bubble-other: #2c2c2e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
            color: var(--text-main);
            overflow: hidden;
            touch-action: manipulation;
            -webkit-user-select: none; user-select: none;
        }

        /* --- é ‚éƒ¨å°èˆª --- */
        .navbar {
            height: 44px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 16px; background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(10px); border-bottom: 0.5px solid #333;
            z-index: 100;
        }

        .status-text { font-size: 14px; font-weight: 600; color: var(--text-sub); }
        .btn-gear { background: none; border: none; font-size: 20px; padding: 8px; cursor: pointer; opacity: 0.8; }

        /* --- è¢å¹•å°è©±å€ --- */
        .screen {
            flex: 1; padding: 20px 16px; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .welcome-text {
            text-align: center; color: #555; margin-top: auto; padding-bottom: 20px;
            font-size: 13px; letter-spacing: 0.5px;
        }

        /* --- å°è©±æ°£æ³¡ --- */
        .msg {
            max-width: 85%; padding: 12px 16px; border-radius: 18px;
            font-size: 17px; line-height: 1.5; /* å¢åŠ è¡Œè·è®“æ—¥æ–‡æ›´å¥½è®€ */
            position: relative; word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            flex-shrink: 0;
            min-height: 24px;
        }
        
        .msg-me { align-self: flex-end; background: var(--bubble-me); color: white; border-bottom-right-radius: 4px; }
        .msg-other { align-self: flex-start; background: var(--bubble-other); color: white; border-bottom-left-radius: 4px; }

        /* ç¿»è­¯æ–‡å­—å€ */
        .translation {
            display: block; margin-top: 8px; padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 19px; /* æ—¥æ–‡ç¿»è­¯å­—å¤§ä¸€é» */
            font-weight: 600; color: #ffcc00;
            min-height: 20px; white-space: pre-wrap;
        }

        /* æ‰“å­—æ¸¸æ¨™ */
        .typing::after {
            content: 'â–‹'; display: inline-block; vertical-align: bottom;
            animation: blink 0.8s infinite; color: #ffcc00; font-size: 16px; margin-left: 2px;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* --- åº•éƒ¨æ§åˆ¶å€ --- */
        .controls {
            background: var(--card-bg);
            border-top-left-radius: 24px; border-top-right-radius: 24px;
            padding: 20px 0 40px 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center;
            z-index: 200;
        }

        /* è† å›Šåˆ‡æ›å™¨ */
        .lang-switch-container {
            background: #2c2c2e; padding: 3px; border-radius: 30px;
            display: flex; margin-bottom: 25px;
        }

        .lang-option {
            padding: 8px 24px; border-radius: 25px; font-size: 14px; font-weight: 600;
            color: #8e8e93; cursor: pointer; transition: all 0.3s ease;
        }
        .lang-option.active { color: #fff; background: #636366; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .lang-option[data-lang="ja"].active { background: var(--btn-red); }
        .lang-option[data-lang="en"].active { background: var(--btn-purple); }

        /* æŒ‰éˆ•å®¹å™¨ */
        .btn-row { display: flex; justify-content: space-evenly; width: 100%; align-items: center; }

        /* åœ“å½¢æŒ‰éˆ• */
        .mic-btn {
            width: 90px; height: 90px; border-radius: 50%; background: #3a3a3c;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; font-size: 20px; font-weight: 700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: transform 0.1s, background 0.3s;
            position: relative; border: 3px solid #3a3a3c;
        }

        .mic-btn:active { transform: scale(0.95); }
        .mic-btn span.label { font-size: 12px; font-weight: 400; color: #aaa; margin-top: 2px; }

        /* éŒ„éŸ³ä¸­æ¨£å¼ */
        .mic-btn.recording { transform: scale(1.1); border-color: #fff; }
        .btn-tw.recording { background: var(--btn-blue); box-shadow: 0 0 30px rgba(0, 122, 255, 0.5); }
        .btn-other.jp-mode.recording { background: var(--btn-red); box-shadow: 0 0 30px rgba(255, 59, 48, 0.5); }
        .btn-other.en-mode.recording { background: var(--btn-purple); box-shadow: 0 0 30px rgba(175, 82, 222, 0.5); }

        /* Modal */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .modal-card {
            background: #2c2c2e; padding: 24px; border-radius: 20px; width: 85%; max-width: 320px;
            text-align: center; border: 1px solid #444; box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }
        .modal-input {
            width: 100%; padding: 12px; margin: 15px 0; background: #1c1c1e;
            border: 1px solid #48484a; border-radius: 10px; color: #fff; font-size: 14px;
            box-sizing: border-box;
        }
        .modal-btn {
            width: 100%; padding: 12px; background: var(--btn-blue); border: none;
            border-radius: 10px; color: white; font-weight: bold; font-size: 16px; cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="navbar">
        <div style="width:30px;"></div>
        <div class="status-text" id="statusText">Ready</div>
        <button class="btn-gear" onclick="openModal()">âš™ï¸</button>
    </div>

    <div class="screen" id="screen">
        <div class="welcome-text">
            é¸æ“‡èªè¨€ âœ é»æ“ŠæŒ‰éˆ•èªªè©±
        </div>
    </div>

    <div class="controls">
        <div class="lang-switch-container">
            <div class="lang-option active" data-lang="ja" onclick="switchLang('ja')">ğŸ‡¯ğŸ‡µ æ—¥æ–‡</div>
            <div class="lang-option" data-lang="en" onclick="switchLang('en')">ğŸ‡ºğŸ‡¸ è‹±æ–‡</div>
        </div>

        <div class="btn-row">
            <div id="btnOther" class="mic-btn btn-other jp-mode">
                <span id="btnOtherText">JP</span>
                <span class="label">å°æ–¹</span>
            </div>
            <div id="btnTW" class="mic-btn btn-tw">
                <span>TW</span>
                <span class="label">æˆ‘</span>
            </div>
        </div>
    </div>

    <div id="keyModal" class="modal">
        <div class="modal-card">
            <h3 style="color:#fff; margin:0 0 10px 0; font-size:18px;">è¨­å®š API Key</h3>
            <input type="password" id="apiKey" class="modal-input" placeholder="è²¼ä¸Š Key...">
            <button class="modal-btn" onclick="saveKey()">å„²å­˜</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let genAI, model;
        let recognition;
        let isRecording = false;
        let btnLock = false;
        let currentBtn = null;
        let audioCtx = null; 
        
        let targetLangMode = 'ja';

        // --- Init ---
        window.openModal = () => document.getElementById('keyModal').style.display = 'flex';
        
        window.saveKey = () => {
            const key = document.getElementById('apiKey').value.trim();
            if(key) {
                localStorage.setItem('gemini_mobile_key_v5', key);
                initAI(key);
                document.getElementById('keyModal').style.display = 'none';
            }
        };

        const savedKey = localStorage.getItem('gemini_mobile_key_v5');
        if(savedKey) {
            document.getElementById('apiKey').value = savedKey;
            initAI(savedKey);
        } else {
            openModal();
        }

        function initAI(key) {
            try {
                genAI = new GoogleGenerativeAI(key);
                model = genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash",
                    systemInstruction: "ä½ æ˜¯ä¸€å€‹å°ˆæ¥­å£è­¯å“¡ã€‚è¦å‰‡ï¼š1. å°‡è¼¸å…¥ç¿»è­¯æˆç›®æ¨™èªè¨€ã€‚2. åªè¼¸å‡ºç¿»è­¯çµæœï¼Œä¸è¦æœ‰ä»»ä½•è§£é‡‹ã€‚3. é¢¨æ ¼è‡ªç„¶å£èªã€‚"
                });
                updateStatus("Ready");
            } catch(e) { 
                updateStatus("Key Error", "#ff453a");
                openModal();
            }
        }

        function updateStatus(text, color = "#8e8e93") {
            const el = document.getElementById('statusText');
            el.innerText = text;
            el.style.color = color;
        }

        // --- åˆ‡æ›èªè¨€ ---
        window.switchLang = (lang) => {
            targetLangMode = lang;
            document.querySelectorAll('.lang-option').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.lang-option[data-lang="${lang}"]`).classList.add('active');
            
            const btnOther = document.getElementById('btnOther');
            const btnText = document.getElementById('btnOtherText');
            
            btnOther.classList.remove('jp-mode', 'en-mode');
            
            if (lang === 'ja') {
                btnOther.classList.add('jp-mode');
                btnText.innerText = "JP";
                updateStatus("æ—¥æ–‡æ¨¡å¼");
            } else {
                btnOther.classList.add('en-mode');
                btnText.innerText = "EN";
                updateStatus("è‹±æ–‡æ¨¡å¼");
            }
        };

        // --- Beep ---
        function playBeep() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime); 
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1); 
        }

        // --- Voice Logic ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        const btnTW = document.getElementById('btnTW');
        const btnOther = document.getElementById('btnOther');

        btnTW.onclick = (e) => handleBtnClick(e, btnTW, 'tw');
        btnOther.onclick = (e) => handleBtnClick(e, btnOther, 'other');

        function handleBtnClick(e, btn, role) {
            e.preventDefault();
            if(btnLock) return;

            window.speechSynthesis.cancel(); 
            const empty = new SpeechSynthesisUtterance('');
            window.speechSynthesis.speak(empty);

            if (isRecording) {
                if(recognition) recognition.stop();
                return;
            }

            let langCode;
            if (role === 'tw') {
                langCode = 'cmn-Hant-TW'; 
            } else {
                langCode = targetLangMode === 'ja' ? 'ja-JP' : 'en-US';
            }

            startRecording(btn, langCode, role);
        }

        function startRecording(btn, lang, role) {
            if(!SpeechRecognition) return;
            if(recognition) { try { recognition.abort(); } catch(e){} }
            
            playBeep();
            btnLock = true;
            setTimeout(() => btnLock = false, 300);

            recognition = new SpeechRecognition();
            
            recognition.lang = lang === 'ja-JP' ? 'ja' : lang;
            recognition.interimResults = true; // æ‰€æœ‰èªè¨€éƒ½å•Ÿç”¨é€å­—é¡¯ç¤º
            recognition.maxAlternatives = 1;
            recognition.continuous = false; 

            // Create Bubble
            let tempMsgDiv = document.createElement('div');
            tempMsgDiv.className = `msg ${role === 'tw' ? 'msg-me' : 'msg-other'}`;
            tempMsgDiv.innerHTML = `<span style="opacity:0.6;">...</span>`; 
            
            const screen = document.getElementById('screen');
            screen.appendChild(tempMsgDiv);
            requestAnimationFrame(() => screen.scrollTop = screen.scrollHeight);

            const welcome = document.querySelector('.welcome-text');
            if(welcome) welcome.style.display = 'none';

            recognition.onstart = () => {
                isRecording = true;
                currentBtn = btn;
                btn.classList.add('recording');
                
                let label = "";
                if (lang === 'ja-JP') label = "Listening (JP)...";
                else if (lang === 'en-US') label = "Listening (EN)...";
                else label = "Listening (TW)...";
                updateStatus(label, "#007aff");
            };

            // å³æ™‚ç¿»è­¯ç›¸é—œè®Šæ•¸
            let transEl = null;
            let lastTranslatedText = '';
            let translateDebounceTimer = null;
            let isFinalized = false;
            let speakLangCode = '';
            let lastTranslatedResult = ''; // ä¿å­˜æœ€å¾Œç¿»è­¯çµæœ
            
            // é å…ˆå»ºç«‹ç¿»è­¯å€å¡Š
            function ensureTranslationElement() {
                if (!transEl) {
                    const transDiv = document.createElement('div');
                    transDiv.className = 'translation typing';
                    tempMsgDiv.appendChild(transDiv);
                    transEl = transDiv;
                }
                return transEl;
            }
            
            // å®Œæˆä¸¦åœæ­¢æ¸¸æ¨™
            function finishTranslation() {
                if (isFinalized) return;
                isFinalized = true;
                
                const el = ensureTranslationElement();
                el.classList.remove('typing');
                
                const finalText = lastTranslatedResult || el.innerText;
                if (finalText) {
                    el.innerHTML = `${finalText} <span style="font-size:16px; margin-left:5px;">ğŸ”Š</span>`;
                    updateStatus("Done");
                    speak(finalText, speakLangCode);
                    
                    tempMsgDiv.onclick = () => {
                        speak(finalText, speakLangCode);
                        tempMsgDiv.style.opacity = '0.6';
                        setTimeout(() => tempMsgDiv.style.opacity = '1', 100);
                    };
                } else {
                    el.classList.remove('typing');
                    updateStatus("Ready");
                }
            }
            
            // å³æ™‚ç¿»è­¯å‡½æ•¸
            async function translateRealtime(text, isFinal = false) {
                if (!text.trim()) return;
                if (isFinalized) return; // å·²å®Œæˆå°±ä¸å†ç¿»è­¯
                
                // ç›¸åŒæ–‡å­—ä¸”ä¸æ˜¯æœ€çµ‚ç‰ˆæœ¬ï¼Œè·³é
                if (text === lastTranslatedText && !isFinal) return;
                lastTranslatedText = text;
                
                // è¨­å®šèªè¨€
                if (role === 'tw') {
                    if (targetLangMode === 'ja') { speakLangCode = 'ja-JP'; } 
                    else { speakLangCode = 'en-US'; }
                } else {
                    speakLangCode = 'zh-TW';
                }
                
                let targetLangName;
                if (role === 'tw') {
                    targetLangName = targetLangMode === 'ja' ? 'Japanese' : 'English';
                } else {
                    targetLangName = 'Traditional Chinese';
                }
                
                try {
                    if (!model) return;
                    updateStatus("å³æ™‚ç¿»è­¯ä¸­...", "#ffcc00");
                    
                    const el = ensureTranslationElement();
                    const result = await model.generateContentStream(`Translate to ${targetLangName}: "${text}"`);
                    
                    let translatedText = '';
                    for await (const chunk of result.stream) {
                        if (isFinalized) break; // å¦‚æœå·²å®Œæˆå°±åœæ­¢
                        translatedText += chunk.text();
                        el.innerText = translatedText;
                        screen.scrollTop = screen.scrollHeight;
                    }
                    
                    lastTranslatedResult = translatedText;
                    
                    // å¦‚æœæ˜¯æœ€çµ‚çµæœï¼Œå®Œæˆç¿»è­¯
                    if (isFinal) {
                        finishTranslation();
                    }
                } catch(e) {
                    if (e.name !== 'AbortError') {
                        console.error('Translation error:', e);
                    }
                }
            }

            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                    else interimTranscript += event.results[i][0].transcript;
                }
                
                const currentText = finalTranscript || interimTranscript;
                
                // æ›´æ–°é¡¯ç¤ºçš„åŸæ–‡
                if (interimTranscript && !finalTranscript) {
                    // ç¢ºä¿ç¿»è­¯å€å¡Šå·²å­˜åœ¨
                    const el = ensureTranslationElement();
                    tempMsgDiv.firstChild.textContent = interimTranscript;
                    if (tempMsgDiv.firstChild.tagName !== 'SPAN') {
                        const span = document.createElement('span');
                        span.style.opacity = '0.7';
                        span.textContent = interimTranscript;
                        tempMsgDiv.insertBefore(span, tempMsgDiv.firstChild);
                        if (tempMsgDiv.childNodes[1] && tempMsgDiv.childNodes[1].nodeType === 3) {
                            tempMsgDiv.childNodes[1].remove();
                        }
                    }
                }
                
                if (finalTranscript) {
                    // æ¸…é™¤ä¹‹å‰çš„å…§å®¹ï¼Œè¨­å®šæœ€çµ‚åŸæ–‡
                    const el = ensureTranslationElement();
                    while (tempMsgDiv.firstChild !== el) {
                        tempMsgDiv.removeChild(tempMsgDiv.firstChild);
                    }
                    tempMsgDiv.insertBefore(document.createTextNode(finalTranscript), el);
                }
                
                screen.scrollTop = screen.scrollHeight;
                
                // å³æ™‚ç¿»è­¯ (ä½¿ç”¨ debounce é¿å…éæ–¼é »ç¹)
                clearTimeout(translateDebounceTimer);
                if (finalTranscript) {
                    // æœ€çµ‚çµæœç«‹å³ç¿»è­¯
                    translateRealtime(finalTranscript, true);
                } else if (interimTranscript && interimTranscript.length > 2) {
                    // æš«æ™‚çµæœå»¶é² 300ms ç¿»è­¯
                    translateDebounceTimer = setTimeout(() => {
                        translateRealtime(interimTranscript, false);
                    }, 300);
                }
            };

            recognition.onend = () => { 
                stopRecording(); 
                clearTimeout(translateDebounceTimer);
                
                // ç¢ºä¿ç¿»è­¯çµæŸå¾Œæ¸¸æ¨™åœæ­¢
                setTimeout(() => {
                    if (!isFinalized && transEl) {
                        finishTranslation();
                    }
                }, 2000); // çµ¦ç¿»è­¯ 2 ç§’å®Œæˆæ™‚é–“
            };
            recognition.onerror = (e) => {
                stopRecording();
                if(e.error === 'aborted' || e.error === 'no-speech') {
                    if(tempMsgDiv.innerText === '...') tempMsgDiv.remove();
                    return;
                }
                updateStatus("è«‹å†è©¦ä¸€æ¬¡", "#ff3b30");
                if(tempMsgDiv.innerText === '...') tempMsgDiv.remove();
            };
            try { recognition.start(); } catch(e) { btnLock = false; }
        }

        function stopRecording() {
            isRecording = false;
            if(currentBtn) currentBtn.classList.remove('recording');
            currentBtn = null;
            updateStatus("Ready");
        }

        // --- å³æ™‚ç¿»è­¯æ¨¡å¼ (å·²æ•´åˆåˆ° startRecording ä¸­) ---

        function speak(text, lang) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang;
            window.speechSynthesis.speak(u);
        }
    </script>
</body>
</html>