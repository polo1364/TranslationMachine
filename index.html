<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰‹æ©Ÿç‰ˆå£è­¯æ©Ÿ</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        :root {
            --bg-color: #121212;
            --btn-blue: #2d7aff;
            --btn-red: #ff453a;
            --text: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
            color: var(--text);
            overflow: hidden;
            touch-action: manipulation;
        }

        /* ç‹€æ…‹åˆ— */
        .status-bar {
            padding: 15px; text-align: center; background: #1e1e1e;
            font-size: 16px; font-weight: bold; color: #888;
            border-bottom: 1px solid #333;
        }

        /* éŒ¯èª¤è¨Šæ¯ (é‡è¦) */
        .debug-info {
            font-size: 12px; color: #ff6b6b; padding: 5px;
            text-align: center; display: none; background: rgba(50,0,0,0.5);
        }

        /* è¢å¹• */
        .screen {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 15px;
        }

        .msg {
            padding: 10px 15px; border-radius: 12px; max-width: 80%;
            font-size: 18px; line-height: 1.4; animation: pop 0.3s;
        }
        @keyframes pop { from{transform:scale(0.9);opacity:0;} to{transform:scale(1);opacity:1;} }

        .msg-me { align-self: flex-end; background: var(--btn-blue); color: #fff; }
        .msg-other { align-self: flex-start; background: #333; color: #fff; border: 1px solid #444; }

        .translation {
            font-size: 20px; font-weight: bold; margin-top: 5px;
            color: #ffe066; /* ç¿»è­¯çµæœäº®é»ƒè‰² */
        }

        /* æŒ‰éˆ•å€ */
        .controls {
            height: 200px; background: #1c1c1e;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 20px; border-top: 1px solid #333;
        }

        .tap-btn {
            width: 120px; height: 120px; border-radius: 50%;
            border: 4px solid #444; background: #2c2c2e;
            color: white; font-size: 18px; font-weight: bold;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 0.2s;
        }

        /* éŒ„éŸ³ä¸­çš„ç‹€æ…‹ */
        .tap-btn.recording {
            border-color: #fff;
            animation: pulse 1.5s infinite;
            transform: scale(1.05);
        }
        
        .btn-tw.recording { background: var(--btn-blue); box-shadow: 0 0 20px var(--btn-blue); }
        .btn-jp.recording { background: var(--btn-red); box-shadow: 0 0 20px var(--btn-red); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Modal */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 99; display: flex;
            justify-content: center; align-items: center;
        }
        .modal-box { background: #333; padding: 20px; border-radius: 10px; width: 80%; text-align: center; }
        input { width: 90%; padding: 10px; margin: 10px 0; font-size: 16px; }
        button { padding: 10px 20px; font-size: 16px; background: var(--btn-blue); color: white; border: none; border-radius: 5px; }

    </style>
</head>
<body>

    <div class="status-bar" id="statusText">è«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹èªªè©±</div>
    <div class="debug-info" id="debugMsg"></div>

    <div class="screen" id="screen">
        <div style="text-align:center; color:#555; margin-top:auto;">
            é»ä¸€ä¸‹é–‹å§‹éŒ„éŸ³ï¼Œå†é»ä¸€ä¸‹çµæŸ
        </div>
    </div>

    <div class="controls">
        <div id="btnJP" class="tap-btn btn-jp">
            <span>JP</span>
            <span style="font-size:12px; color:#aaa;">å°æ–¹</span>
        </div>
        <div id="btnTW" class="tap-btn btn-tw">
            <span>TW</span>
            <span style="font-size:12px; color:#aaa;">æˆ‘</span>
        </div>
    </div>

    <div id="keyModal" class="modal">
        <div class="modal-box">
            <h3>ğŸ”‘ è¼¸å…¥ API Key</h3>
            <input type="password" id="apiKey" placeholder="Gemini API Key">
            <button onclick="saveKey()">ç¢ºå®š</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let genAI, model;
        let recognition;
        let isRecording = false;
        let currentBtn = null;

        // --- é™¤éŒ¯å·¥å…· ---
        function log(msg, isError = false) {
            const debugEl = document.getElementById('debugMsg');
            debugEl.style.display = 'block';
            debugEl.innerText = msg;
            if(isError) debugEl.style.color = '#ff4d4d';
            else debugEl.style.color = '#4dff4d';
            console.log(msg);
        }

        // --- åˆå§‹åŒ– API ---
        window.saveKey = () => {
            const key = document.getElementById('apiKey').value;
            if(key) {
                localStorage.setItem('gemini_mobile_key', key);
                initAI(key);
                document.getElementById('keyModal').style.display = 'none';
            }
        };

        const savedKey = localStorage.getItem('gemini_mobile_key');
        if(savedKey) {
            document.getElementById('apiKey').value = savedKey;
            initAI(savedKey);
            document.getElementById('keyModal').style.display = 'none';
        }

        function initAI(key) {
            try {
                genAI = new GoogleGenerativeAI(key);
                model = genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash",
                    systemInstruction: "ä½ æ˜¯ä¸€å€‹å£è­¯æ©Ÿã€‚å°‡è¼¸å…¥ç¿»è­¯æˆç›®æ¨™èªè¨€ã€‚è¦å‰‡ï¼šé“åœ°ã€ç°¡æ½”ã€‚"
                });
                log("ç³»çµ±å°±ç·’ (HTTPS æª¢æŸ¥ä¸­...)");
            } catch(e) { log("API Key éŒ¯èª¤", true); }
        }

        // --- æª¢æŸ¥ç€è¦½å™¨æ”¯æ´ ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SpeechRecognition) {
            log("âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ (iPhoneè«‹ç”¨Safari, Androidè«‹ç”¨Chrome)", true);
            alert("âŒ ç€è¦½å™¨ä¸æ”¯æ´ï¼š\niPhone è«‹ç”¨ Safari\nAndroid è«‹ç”¨ Chrome\nä¸è¦ç”¨ Line/FB é–‹å•Ÿ");
        } else if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            log("âŒ åš´é‡éŒ¯èª¤ï¼šç¶²å€é HTTPSï¼Œéº¥å…‹é¢¨å°‡è¢«å°é–", true);
            alert("âš ï¸ å®‰å…¨æ€§è­¦å‘Š âš ï¸\næ‰‹æ©Ÿç„¡æ³•åœ¨é HTTPS ç¶²å€ä½¿ç”¨éº¥å…‹é¢¨ã€‚\nè«‹ä¸è¦ä½¿ç”¨ IP (192.168...) é€£ç·šã€‚");
        }

        // --- æŒ‰éˆ•é‚è¼¯ (é»æ“Šåˆ‡æ›) ---
        function setupBtn(id, lang, type) {
            const btn = document.getElementById(id);
            
            btn.onclick = () => {
                // å¦‚æœæ­£åœ¨éŒ„éŸ³ï¼Œå‰‡åœæ­¢
                if (isRecording) {
                    if (currentBtn === btn) {
                        stopRecording(); // æŒ‰åŒä¸€å€‹æŒ‰éˆ• -> åœæ­¢
                    } else {
                        // æŒ‰ä¸åŒæŒ‰éˆ• -> ç„¡è¦–ï¼Œæˆ–åˆ‡æ› (é€™è£¡å…ˆè¨­ç‚ºç„¡è¦–)
                    }
                } else {
                    // é–‹å§‹éŒ„éŸ³
                    startRecording(btn, lang, type);
                }
            };
        }

        function startRecording(btn, lang, type) {
            if(!SpeechRecognition) return;
            
            recognition = new SpeechRecognition();
            recognition.lang = lang;
            recognition.interimResults = false;
            recognition.continuous = false; // æ‰‹æ©Ÿä¸Šè¨­ç‚º false æ¯”è¼ƒç©©

            recognition.onstart = () => {
                isRecording = true;
                currentBtn = btn;
                btn.classList.add('recording');
                document.getElementById('statusText').innerText = "ğŸ¤ è†è½ä¸­...";
                log("éº¥å…‹é¢¨å•Ÿå‹•æˆåŠŸ");
            };

            recognition.onend = () => {
                stopRecording();
            };

            recognition.onerror = (e) => {
                stopRecording();
                let err = e.error;
                if(err === 'not-allowed') err = "éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ• (è«‹æª¢æŸ¥è¨­å®š)";
                if(err === 'network') err = "ç¶²è·¯é€£ç·šå¤±æ•— (APIéœ€è¦é€£ç¶²)";
                log(`âŒ éŒ¯èª¤: ${err}`, true);
            };

            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                processText(text, type);
            };

            try {
                recognition.start();
            } catch(e) {
                log("å•Ÿå‹•å¤±æ•—: " + e.message, true);
            }
        }

        function stopRecording() {
            if(recognition) recognition.stop();
            isRecording = false;
            if(currentBtn) currentBtn.classList.remove('recording');
            currentBtn = null;
            document.getElementById('statusText').innerText = "è«‹é»æ“ŠæŒ‰éˆ•é–‹å§‹èªªè©±";
        }

        // --- ç¿»è­¯èˆ‡é¡¯ç¤º ---
        async function processText(text, type) {
            if(!text.trim()) return;
            
            // UI é¡¯ç¤º
            const screen = document.getElementById('screen');
            const div = document.createElement('div');
            div.className = `msg ${type === 'tw' ? 'msg-me' : 'msg-other'}`;
            div.innerHTML = `<div>${text}</div><div class="translation">...</div>`;
            screen.appendChild(div);
            screen.scrollTop = screen.scrollHeight;
            
            const target = type === 'tw' ? 'Japanese' : 'Traditional Chinese';
            
            try {
                const result = await model.generateContent(`Translate to ${target}: "${text}"`);
                const transText = result.response.text();
                
                div.querySelector('.translation').innerText = transText;
                
                // æœ—è®€
                const u = new SpeechSynthesisUtterance(transText);
                u.lang = type === 'tw' ? 'ja-JP' : 'zh-TW';
                window.speechSynthesis.speak(u);

            } catch(e) {
                div.querySelector('.translation').innerText = "ç¿»è­¯å¤±æ•—";
                log("API éŒ¯èª¤: " + e.message, true);
            }
        }

        setupBtn('btnTW', 'cmn-Hant-TW', 'tw');
        setupBtn('btnJP', 'ja-JP', 'jp');

    </script>
</body>
</html>