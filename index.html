<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iOS ç©©å®šç‰ˆå£è­¯æ©Ÿ</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        :root {
            --bg-color: #000000;
            --btn-blue: #0a84ff;
            --btn-red: #ff453a;
            --text: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
            color: var(--text);
            overflow: hidden;
            /* iOS é‡è¦è¨­å®šï¼šé˜²æ­¢é›™æ“Šæ”¾å¤§ */
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        /* ç‹€æ…‹åˆ— */
        .status-bar {
            padding: 15px; text-align: center; background: #1c1c1e;
            font-size: 15px; font-weight: bold; color: #888;
            border-bottom: 1px solid #333;
            min-height: 20px;
        }

        /* éŒ¯èª¤è¨Šæ¯ */
        .debug-info {
            font-size: 13px; color: #ff6b6b; padding: 8px;
            text-align: center; display: none; background: rgba(50,0,0,0.8);
            position: fixed; top: 50px; left: 0; width: 100%; z-index: 99;
        }

        /* è¢å¹•é¡¯ç¤ºå€ */
        .screen {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 15px;
            /* è®“æ²å‹•é †æš¢ */
            -webkit-overflow-scrolling: touch;
        }

        .msg {
            padding: 12px 16px; border-radius: 16px; max-width: 85%;
            font-size: 19px; line-height: 1.4; animation: pop 0.2s;
        }
        @keyframes pop { from{transform:scale(0.9);opacity:0;} to{transform:scale(1);opacity:1;} }

        .msg-me { align-self: flex-end; background: var(--btn-blue); color: #fff; }
        .msg-other { align-self: flex-start; background: #333; color: #fff; }

        .translation {
            font-size: 21px; font-weight: 700; margin-top: 6px;
            color: #ffd700; /* é‡‘é»ƒè‰² */
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 6px;
        }

        /* æŒ‰éˆ•å€ */
        .controls {
            height: 220px; background: #1c1c1e;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 30px; border-top: 1px solid #333;
        }

        .tap-btn {
            width: 130px; height: 130px; border-radius: 50%;
            border: 3px solid #444; background: #2c2c2e;
            color: white; font-size: 20px; font-weight: bold;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            /* ç§»é™¤é»æ“Šé«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }

        .tap-btn span.sub { font-size: 13px; color: #aaa; margin-top: 4px; font-weight: normal; }

        /* éŒ„éŸ³ä¸­ç‰¹æ•ˆ */
        .tap-btn.recording {
            border-color: #fff;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        
        .btn-tw.recording { background: var(--btn-blue); }
        .btn-jp.recording { background: var(--btn-red); }

        /* é–å®šç‹€æ…‹ (é˜²æ­¢é€£é») */
        .tap-btn.locked { opacity: 0.5; pointer-events: none; }

        /* Modal */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); z-index: 999; display: flex;
            justify-content: center; align-items: center;
        }
        .modal-box { background: #2c2c2e; padding: 25px; border-radius: 16px; width: 80%; text-align: center; border: 1px solid #444; }
        input { width: 90%; padding: 12px; margin: 15px 0; font-size: 16px; background: #111; color: #fff; border: 1px solid #555; border-radius: 8px; }
        button { padding: 12px 24px; font-size: 16px; background: var(--btn-blue); color: white; border: none; border-radius: 8px; font-weight: bold; }

    </style>
</head>
<body>

    <div class="status-bar" id="statusText">å°±ç·’</div>
    <div class="debug-info" id="debugMsg"></div>

    <div class="screen" id="screen">
        <div style="text-align:center; color:#555; margin-top:auto; padding-bottom:20px;">
            é»æ“ŠæŒ‰éˆ•é–‹å§‹ âœ è¬›å®Œè‡ªå‹•åœæ­¢
        </div>
    </div>

    <div class="controls">
        <div id="btnJP" class="tap-btn btn-jp">
            <span>JP</span>
            <span class="sub">å°æ–¹</span>
        </div>
        <div id="btnTW" class="tap-btn btn-tw">
            <span>TW</span>
            <span class="sub">æˆ‘</span>
        </div>
    </div>

    <div id="keyModal" class="modal">
        <div class="modal-box">
            <h3 style="color:#fff; margin:0;">ğŸ”‘ è¼¸å…¥ API Key</h3>
            <p style="color:#aaa; font-size:13px;">è«‹è¼¸å…¥ Google Gemini Key</p>
            <input type="password" id="apiKey" placeholder="è²¼ä¸Š API Key">
            <button onclick="saveKey()">ç¢ºå®š</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let genAI, model;
        let recognition;
        let isRecording = false;
        let btnLock = false; // é˜²æ­¢é€£é»é–
        let currentBtn = null;

        // --- é™¤éŒ¯å·¥å…· ---
        function log(msg, isError = false) {
            const debugEl = document.getElementById('debugMsg');
            if(isError) {
                // å¦‚æœæ˜¯ abortedï¼Œæˆ‘å€‘é¸æ“‡å¿½è¦–å®ƒï¼Œé™¤éä½ æƒ³çœ‹
                if(msg.includes('aborted')) return; 
                debugEl.style.display = 'block';
                debugEl.innerText = msg;
                setTimeout(() => debugEl.style.display = 'none', 3000); // 3ç§’å¾Œæ¶ˆå¤±
            } else {
                // æˆåŠŸè¨Šæ¯åªé¡¯ç¤ºåœ¨ç‹€æ…‹åˆ—ï¼Œä¸æ“‹ç•«é¢
                document.getElementById('statusText').innerText = msg;
            }
            console.log(msg);
        }

        // --- åˆå§‹åŒ– API ---
        window.saveKey = () => {
            const key = document.getElementById('apiKey').value.trim();
            if(key) {
                localStorage.setItem('gemini_mobile_key_v2', key);
                initAI(key);
                document.getElementById('keyModal').style.display = 'none';
            }
        };

        const savedKey = localStorage.getItem('gemini_mobile_key_v2');
        if(savedKey) {
            document.getElementById('apiKey').value = savedKey;
            initAI(savedKey);
            document.getElementById('keyModal').style.display = 'none';
        }

        function initAI(key) {
            try {
                genAI = new GoogleGenerativeAI(key);
                model = genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash",
                    systemInstruction: "ä½ æ˜¯ä¸€å€‹é›™å‘å£è­¯æ©Ÿã€‚å°‡è¼¸å…¥ç¿»è­¯æˆç›®æ¨™èªè¨€(ä¸­æ–‡æˆ–æ—¥æ–‡)ã€‚è¦å‰‡ï¼šç›´æ¥è¼¸å‡ºç¿»è­¯çµæœï¼Œä¸è¦è§£é‡‹ã€‚é¢¨æ ¼ï¼šè‡ªç„¶å£èªã€‚"
                });
                log("ç³»çµ±å°±ç·’");
            } catch(e) { log("API Key éŒ¯èª¤", true); }
        }

        // --- æª¢æŸ¥ç€è¦½å™¨ ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SpeechRecognition) {
            alert("âš ï¸ æ‚¨çš„æ‰‹æ©Ÿç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜\nè«‹ä½¿ç”¨ Chrome (Android) æˆ– Safari (iOS)");
        }

        // --- æ ¸å¿ƒï¼šç©©å®šçš„èªéŸ³æ§åˆ¶ ---
        function setupBtn(id, lang, type) {
            const btn = document.getElementById(id);
            
            btn.onclick = (e) => {
                e.preventDefault(); // é˜²æ­¢è§¸ç™¼å…©æ¬¡

                // 1. é˜²æ­¢é€£é» (å†·å»æ™‚é–“)
                if(btnLock) return;
                
                // 2. å¦‚æœæ­£åœ¨éŒ„éŸ³ï¼Œé»æ“Šå°±æ˜¯åœæ­¢
                if (isRecording) {
                    stopRecording();
                    return;
                }

                // 3. é–‹å§‹éŒ„éŸ³
                startRecording(btn, lang, type);
            };
        }

        function startRecording(btn, lang, type) {
            if(!SpeechRecognition) return;

            // é–ä½æŒ‰éˆ• 0.5 ç§’ï¼Œé˜²æ­¢èª¤è§¸
            btnLock = true;
            setTimeout(() => btnLock = false, 500);

            recognition = new SpeechRecognition();
            recognition.lang = lang;
            recognition.interimResults = false; // iOS å»ºè­°é—œé–‰å³æ™‚é è¦½ï¼Œæ¯”è¼ƒç©©
            recognition.continuous = false;     // iOS å¿…é ˆè¨­ç‚º falseï¼Œè¬›å®Œä¸€å¥è‡ªå‹•åœ

            recognition.onstart = () => {
                isRecording = true;
                currentBtn = btn;
                btn.classList.add('recording');
                document.getElementById('statusText').innerText = "ğŸ¤ è†è½ä¸­...";
                document.getElementById('statusText').style.color = "#0a84ff";
            };

            recognition.onend = () => {
                stopRecording();
            };

            recognition.onerror = (e) => {
                // é»˜é»˜åœæ­¢ï¼Œä¸è¦å™´éŒ¯
                stopRecording();
                let msg = e.error;
                if(msg === 'not-allowed') log("âŒ éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’ (è«‹å»è¨­å®šé–‹å•Ÿ)", true);
                else if(msg === 'network') log("âŒ ç„¡ç¶²è·¯é€£ç·š", true);
                else if(msg !== 'aborted' && msg !== 'no-speech') log("âŒ " + msg, true);
            };

            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                processText(text, type);
            };

            try {
                recognition.start();
            } catch(e) {
                console.error(e);
                btnLock = false;
            }
        }

        function stopRecording() {
            if(recognition) {
                try { recognition.stop(); } catch(e){}
            }
            isRecording = false;
            if(currentBtn) currentBtn.classList.remove('recording');
            currentBtn = null;
            document.getElementById('statusText').innerText = "å°±ç·’";
            document.getElementById('statusText').style.color = "#888";
        }

        // --- ç¿»è­¯èˆ‡é¡¯ç¤º ---
        async function processText(text, type) {
            if(!text.trim()) return;
            
            // UI
            const screen = document.getElementById('screen');
            const div = document.createElement('div');
            div.className = `msg ${type === 'tw' ? 'msg-me' : 'msg-other'}`;
            div.innerHTML = `<div>${text}</div><div class="translation">...</div>`;
            screen.appendChild(div);
            screen.scrollTop = screen.scrollHeight;
            
            const target = type === 'tw' ? 'Japanese' : 'Traditional Chinese';
            
            try {
                if(!model) throw new Error("API Key unset");
                const result = await model.generateContent(`Translate to ${target}: "${text}"`);
                const transText = result.response.text();
                
                div.querySelector('.translation').innerText = transText;
                
                // æ’­æ”¾èªéŸ³
                speak(transText, type === 'tw' ? 'ja-JP' : 'zh-TW');

            } catch(e) {
                div.querySelector('.translation').innerText = "ç¿»è­¯å¤±æ•—";
                log("API Error", true);
            }
        }

        function speak(text, lang) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang;
            window.speechSynthesis.speak(u);
        }

        setupBtn('btnTW', 'cmn-Hant-TW', 'tw');
        setupBtn('btnJP', 'ja-JP', 'jp');

    </script>
</body>
</html>