<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å£è­¯æ©Ÿ (æ—¥æ–‡ä¿®å¾©+æ‰“å­—ç‰¹æ•ˆ)</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        :root {
            --bg-color: #000000;
            --btn-blue: #0a84ff;
            --btn-red: #ff453a;
            --text: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
            color: var(--text);
            overflow: hidden;
            touch-action: manipulation;
            -webkit-user-select: none; user-select: none;
        }

        /* ç‹€æ…‹åˆ— */
        .status-bar {
            padding: 12px; text-align: center; background: #1c1c1e;
            font-size: 15px; font-weight: bold; color: #888;
            border-bottom: 1px solid #333; min-height: 20px;
        }

        /* è¢å¹• */
        .screen {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .msg {
            padding: 12px 16px; border-radius: 16px; max-width: 85%;
            font-size: 20px; line-height: 1.4; 
            position: relative; cursor: pointer;
            min-height: 24px; /* é˜²æ­¢æ‰“å­—æ™‚é«˜åº¦è·³å‹• */
        }

        .msg-me { align-self: flex-end; background: var(--btn-blue); color: #fff; }
        .msg-other { align-self: flex-start; background: #333; color: #fff; }

        .translation {
            font-size: 22px; font-weight: 700; margin-top: 8px;
            color: #ffd700; border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 6px;
            white-space: pre-wrap;
        }

        /* ğŸ”¥ æ‰“å­—æ¸¸æ¨™ç‰¹æ•ˆ ğŸ”¥ */
        .typing::after {
            content: 'â–‹';
            display: inline-block;
            vertical-align: bottom;
            animation: blink 1s infinite;
            color: #ffd700;
            font-size: 18px;
            margin-left: 2px;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* æŒ‰éˆ•å€ */
        .controls {
            height: 240px; background: #1c1c1e;
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: 40px; border-top: 1px solid #333;
        }

        .tap-btn {
            width: 120px; height: 120px; border-radius: 50%;
            border: 3px solid #444; background: #2c2c2e;
            color: white; font-size: 20px; font-weight: bold;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 0.1s; cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .tap-btn span.sub { font-size: 13px; color: #aaa; margin-top: 4px; font-weight: normal; }

        .tap-btn.recording {
            border-color: #fff; transform: scale(1.1);
            box-shadow: 0 0 25px rgba(255,255,255,0.3);
        }
        .btn-tw.recording { background: var(--btn-blue); }
        .btn-jp.recording { background: var(--btn-red); }

        /* Modal */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); z-index: 999; display: flex;
            justify-content: center; align-items: center;
        }
        .modal-box { background: #2c2c2e; padding: 25px; border-radius: 16px; width: 80%; text-align: center; border: 1px solid #444; }
        input { width: 90%; padding: 12px; margin: 15px 0; font-size: 16px; background: #111; color: #fff; border: 1px solid #555; border-radius: 8px; }
        button { padding: 12px 24px; font-size: 16px; background: var(--btn-blue); color: white; border: none; border-radius: 8px; font-weight: bold; }

        /* è­¦å‘Šæ¡† */
        .alert-box {
            background: #4a0000; color: #ffcccc; padding: 15px; margin: 10px 0; border-radius: 10px; font-size: 14px; text-align: left; display: none;
        }

    </style>
</head>
<body>

    <div class="status-bar" id="statusText">å°±ç·’</div>

    <div class="screen" id="screen">
        <div style="text-align:center; color:#555; margin-top:auto; padding-bottom:20px;">
            è«‹ç¢ºèª iPhone å·²æ–°å¢æ—¥æ–‡éµç›¤<br>æ‰èƒ½æ¥æ”¶æ—¥æ–‡èªéŸ³
        </div>
    </div>

    <div class="controls">
        <div id="btnJP" class="tap-btn btn-jp">
            <span>JP</span>
            <span class="sub">å°æ–¹</span>
        </div>
        <div id="btnTW" class="tap-btn btn-tw">
            <span>TW</span>
            <span class="sub">æˆ‘</span>
        </div>
    </div>

    <div id="keyModal" class="modal">
        <div class="modal-box">
            <h3 style="color:#fff; margin:0;">ğŸ”‘ è¼¸å…¥ API Key</h3>
            <input type="password" id="apiKey" placeholder="è²¼ä¸Š API Key">
            <button onclick="saveKey()">ç¢ºå®š</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let genAI, model;
        let recognition;
        let isRecording = false;
        let btnLock = false;
        let currentBtn = null;
        let silenceTimer = null; 

        // --- åˆå§‹åŒ– API ---
        window.saveKey = () => {
            const key = document.getElementById('apiKey').value.trim();
            if(key) {
                localStorage.setItem('gemini_mobile_key_v2', key);
                initAI(key);
                document.getElementById('keyModal').style.display = 'none';
            }
        };

        const savedKey = localStorage.getItem('gemini_mobile_key_v2');
        if(savedKey) {
            document.getElementById('apiKey').value = savedKey;
            initAI(savedKey);
            document.getElementById('keyModal').style.display = 'none';
        }

        function initAI(key) {
            try {
                genAI = new GoogleGenerativeAI(key);
                model = genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash",
                    systemInstruction: "ä½ æ˜¯ä¸€å€‹å°ˆæ¥­å£è­¯å“¡ã€‚å°‡è¼¸å…¥ç¿»è­¯æˆç›®æ¨™èªè¨€ã€‚è¦å‰‡ï¼šç›´æ¥è¼¸å‡ºç¿»è­¯çµæœï¼Œä¸è§£é‡‹ï¼Œé¢¨æ ¼è‡ªç„¶å£èªã€‚"
                });
            } catch(e) { alert("Key Error"); }
        }

        // --- æ ¸å¿ƒèªéŸ³é‚è¼¯ (ä¿ç•™æ‚¨åŸç‰ˆè¨­å®š) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        function setupBtn(id, lang, type) {
            const btn = document.getElementById(id);
            btn.onclick = (e) => {
                e.preventDefault();
                if(btnLock) return;

                window.speechSynthesis.cancel(); 
                if (isRecording) {
                    if(recognition) recognition.stop();
                    return;
                }
                startRecording(btn, lang, type);
            };
        }

        function startRecording(btn, lang, type) {
            if(!SpeechRecognition) return;

            if(recognition) { try { recognition.abort(); } catch(e){} }

            btnLock = true;
            setTimeout(() => btnLock = false, 300);

            recognition = new SpeechRecognition();
            recognition.lang = lang; // é—œéµï¼šja-JP
            recognition.interimResults = true; 
            recognition.continuous = false; 

            // æš«å­˜æ°£æ³¡
            let tempMsgDiv = document.createElement('div');
            tempMsgDiv.className = `msg ${type === 'tw' ? 'msg-me' : 'msg-other'}`;
            tempMsgDiv.innerHTML = `<span style="font-style:italic; opacity:0.7;">${lang==='ja-JP'?'æ—¥æ–‡è†è½ä¸­...':'è†è½ä¸­...'}</span>`; 
            document.getElementById('screen').appendChild(tempMsgDiv);
            document.getElementById('screen').scrollTop = document.getElementById('screen').scrollHeight;

            recognition.onstart = () => {
                isRecording = true;
                currentBtn = btn;
                btn.classList.add('recording');
                document.getElementById('statusText').innerText = lang === 'ja-JP' ? "ğŸ‡¯ğŸ‡µ è«‹èªªæ—¥æ–‡" : "ğŸ‡¹ğŸ‡¼ è«‹èªªä¸­æ–‡";
                document.getElementById('statusText').style.color = "#0a84ff";

                // ğŸ”¥ æ—¥æ–‡å°ˆå±¬è¨ºæ–·ï¼š4ç§’æ²’çµæœå°±å ±è­¦ (ä¿ç•™åŸç‰ˆè¨­å®š) ğŸ”¥
                if (lang === 'ja-JP') {
                    clearTimeout(silenceTimer);
                    silenceTimer = setTimeout(() => {
                        if(isRecording && tempMsgDiv.innerText.includes("è†è½ä¸­")) {
                            recognition.stop();
                            tempMsgDiv.innerHTML = `
                                <div style="color:#ff6b6b; font-size:16px; font-weight:bold;">âŒ è½ä¸åˆ°æ—¥æ–‡ï¼Ÿ</div>
                                <div class="alert-box" style="display:block;">
                                    1. é€²å…¥ iPhone [è¨­å®š] > [ä¸€èˆ¬] > [éµç›¤]<br>
                                    2. æ–°å¢éµç›¤ > <b>[æ—¥æ–‡]</b><br>
                                    3. ç¢ºèª [å•Ÿç”¨è½å¯«] å·²é–‹å•Ÿ<br>
                                    4. é€²å» [è½å¯«èªè¨€] å‹¾é¸ [æ—¥æ–‡]
                                </div>
                            `;
                            document.getElementById('screen').scrollTop = document.getElementById('screen').scrollHeight;
                        }
                    }, 4000); 
                }
            };

            recognition.onresult = (event) => {
                clearTimeout(silenceTimer); // æœ‰æ”¶åˆ°å­—ï¼Œå–æ¶ˆå ±è­¦

                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                
                if (interimTranscript) tempMsgDiv.innerHTML = `<span style="color:gray">${interimTranscript}</span>`;
                if (finalTranscript) {
                    tempMsgDiv.innerHTML = finalTranscript;
                    processText(finalTranscript, type, tempMsgDiv);
                }
            };

            recognition.onend = () => { stopRecording(); };
            
            recognition.onerror = (e) => {
                stopRecording();
                clearTimeout(silenceTimer);
                if(e.error === 'aborted' || e.error === 'no-speech') {
                    if(tempMsgDiv.innerText.includes("è†è½ä¸­")) tempMsgDiv.remove();
                    return;
                }
                tempMsgDiv.innerHTML = `<span style="color:#ff6b6b;">âŒ éŒ¯èª¤: ${e.error}</span>`;
            };

            try { recognition.start(); } catch(e) { btnLock = false; }
        }

        function stopRecording() {
            isRecording = false;
            clearTimeout(silenceTimer);
            if(currentBtn) currentBtn.classList.remove('recording');
            currentBtn = null;
            document.getElementById('statusText').innerText = "å°±ç·’";
            document.getElementById('statusText').style.color = "#888";
        }

        // --- ç¿»è­¯èˆ‡æœ—è®€ (ğŸ”¥ ä¿®æ”¹ç‚ºæ‰“å­—æ©Ÿç‰¹æ•ˆç‰ˆ ğŸ”¥) ---
        async function processText(text, type, msgDiv) {
            if(!text.trim()) return;
            
            // åŠ ä¸Šç¿»è­¯å€å¡Šï¼Œå¸¶æœ‰ typing class
            msgDiv.innerHTML += `<div class="translation typing"></div>`;
            const transEl = msgDiv.querySelector('.translation');
            const screen = document.getElementById('screen');
            screen.scrollTop = screen.scrollHeight;
            
            const target = type === 'tw' ? 'Japanese' : 'Traditional Chinese';
            const speakLang = type === 'tw' ? 'ja-JP' : 'zh-TW';
            
            try {
                if(!model) throw new Error("API Key unset");
                
                // 1. æ”¹ç”¨æµå¼å‚³è¼¸
                const result = await model.generateContentStream(`Translate to ${target}: "${text}"`);
                
                let fullTextBuffer = "";
                let displayedText = "";
                let streamFinished = false;

                // 2. è¦–è¦ºç·©è¡æ‰“å­—æ©Ÿ (Visual Typer)
                const typeInterval = setInterval(() => {
                    if (displayedText.length < fullTextBuffer.length) {
                        displayedText += fullTextBuffer[displayedText.length];
                        transEl.innerText = displayedText;
                        screen.scrollTop = screen.scrollHeight;
                    } else if (streamFinished && displayedText.length === fullTextBuffer.length) {
                        clearInterval(typeInterval);
                        finalizeTranslation(transEl, fullTextBuffer, speakLang, msgDiv);
                    }
                }, 50); // æ¯ 50ms åä¸€å€‹å­—

                // 3. æ¥æ”¶è³‡æ–™
                for await (const chunk of result.stream) {
                    fullTextBuffer += chunk.text();
                }
                streamFinished = true;

            } catch(e) { 
                transEl.innerText = "ç¿»è­¯å¤±æ•—"; 
                transEl.classList.remove('typing');
            }
        }

        function finalizeTranslation(el, text, lang, container) {
            el.classList.remove('typing'); // ç§»é™¤æ¸¸æ¨™
            el.innerHTML = `${text} <span style="font-size:16px">ğŸ”Š</span>`; // åŠ ä¸Šå–‡å­
            
            speak(text, lang);
            
            container.onclick = () => {
                speak(text, lang);
                container.style.opacity = '0.7';
                setTimeout(() => container.style.opacity = '1', 100);
            };
        }

        function speak(text, lang) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang;
            window.speechSynthesis.speak(u);
        }

        setupBtn('btnTW', 'cmn-Hant-TW', 'tw');
        setupBtn('btnJP', 'ja-JP', 'jp');

    </script>
</body>
</html>