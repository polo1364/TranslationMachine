<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini 2.5 Âè£Ë≠ØÊ©ü (Èô§ÈåØÁâà)</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        :root {
            --bg-color: #121212;
            --btn-me: #2d7aff;
            --btn-other: #ff453a;
            --text-color: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
            color: var(--text-color);
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Â∞éËà™ */
        .navbar {
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            background: rgba(30,30,30,0.8); backdrop-filter: blur(10px); z-index: 10;
        }
        .status-text { font-size: 14px; color: #888; font-weight: bold; }

        /* Ëû¢Âπï */
        .screen {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
            scroll-behavior: smooth;
        }
        
        .error-msg {
            background: rgba(255, 0, 0, 0.2); border: 1px solid red; color: #ffcccc;
            padding: 10px; border-radius: 8px; font-size: 14px; text-align: center;
            margin-top: auto;
        }

        .msg-group { display: flex; flex-direction: column; gap: 6px; opacity: 0; animation: fadeIn 0.3s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .label { font-size: 12px; color: #666; letter-spacing: 1px; text-transform: uppercase; }
        .result-text { font-size: 24px; font-weight: 700; line-height: 1.3; }
        .original-text { font-size: 14px; color: #888; }
        
        .msg-me { align-items: flex-end; text-align: right; }
        .msg-me .result-text { color: var(--btn-other); }
        .msg-me .label { color: var(--btn-me); }
        .msg-other { align-items: flex-start; text-align: left; }
        .msg-other .result-text { color: var(--btn-me); }
        .msg-other .label { color: var(--btn-other); }

        /* ÊéßÂà∂ÂçÄ */
        .controls {
            height: 240px; background: #1c1c1e; border-top: 1px solid #333;
            display: flex; justify-content: center; align-items: center; gap: 20px;
            padding-bottom: 20px;
        }
        .push-btn {
            width: 130px; height: 130px; border-radius: 50%; border: 4px solid #333; background: #2c2c2e;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: transform 0.1s; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .push-btn:active, .push-btn.active { transform: scale(0.92); border-color: #fff; }
        .btn-tw { background: radial-gradient(circle, #2d7aff 0%, #0040dd 100%); }
        .btn-jp { background: radial-gradient(circle, #ff453a 0%, #d70015 100%); }
        .lang-code { font-size: 32px; font-weight: 900; color: #fff; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; display: none;
            align-items: center; justify-content: center;
        }
        .modal-content { background: #2c2c2e; padding: 25px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; }
        .api-input { width: 100%; padding: 12px; margin: 15px 0; background: #1c1c1e; color: #fff; border: 1px solid #555; }
        .btn-save { background: var(--btn-me); color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; font-weight: bold; }
        
        .typing::after { content: '‚ñã'; animation: blink 1s infinite; color: #fff; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="status-text" id="statusText">Ë´ãÊåâ‰ΩèÊåâÈàïË™™Ë©±</div>
        <button id="settingBtn" style="background:none; border:none; font-size:20px; cursor:pointer;">‚öôÔ∏è</button>
    </div>

    <div id="screen" class="screen">
        <div id="errorDisplay" class="error-msg" style="display:none;"></div>
    </div>

    <div class="controls">
        <div id="btnJP" class="push-btn btn-jp"><div class="lang-code">JP</div><div style="font-size:12px; color:#ddd; margin-top:5px;">Â∞çÊñπ</div></div>
        <div id="btnTW" class="push-btn btn-tw"><div class="lang-code">TW</div><div style="font-size:12px; color:#ddd; margin-top:5px;">Êàë</div></div>
    </div>

    <div id="keyModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:#fff;">üîë Ë®≠ÂÆö API Key</h3>
            <input type="password" id="apiKeyInput" class="api-input" placeholder="Ë≤º‰∏ä API Key">
            <button id="saveKeyBtn" class="btn-save">Á¢∫Ë™ç</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const els = {
            screen: document.getElementById('screen'),
            status: document.getElementById('statusText'),
            errorDisplay: document.getElementById('errorDisplay'),
            modal: document.getElementById('keyModal'),
            input: document.getElementById('apiKeyInput'),
            saveBtn: document.getElementById('saveKeyBtn'),
            settingBtn: document.getElementById('settingBtn')
        };

        let genAI, model;
        
        // ÂàùÂßãÂåñ
        const savedKey = localStorage.getItem('gemini_api_key_v3');
        if (savedKey) { els.input.value = savedKey; initAI(savedKey); }
        else { els.modal.style.display = 'flex'; }

        function initAI(key) {
            try {
                genAI = new GoogleGenerativeAI(key);
                model = genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash",
                    systemInstruction: "‰Ω†ÊòØ‰∏ÄÂÄãÂ∞àÊ•≠Âè£Ë≠ØÂì°„ÄÇÂ∞áËº∏ÂÖ•ÁøªË≠ØÊàêÁõÆÊ®ôË™ûË®Ä„ÄÇË¶èÂâáÔºöÈÅìÂú∞„ÄÅËá™ÁÑ∂„ÄÅ‰∏çËß£Èáã„ÄÇ"
                });
                els.status.innerText = "Gemini 2.5 Ready";
            } catch (e) { console.error(e); }
        }

        els.saveBtn.addEventListener('click', () => {
            const key = els.input.value.trim();
            if(key) { localStorage.setItem('gemini_api_key_v3', key); initAI(key); els.modal.style.display = 'none'; }
        });
        els.settingBtn.addEventListener('click', () => els.modal.style.display = 'flex');

        // --- ÁøªË≠ØËàáÊúóËÆÄ ---
        async function translate(text, type) {
            if (!model) return;
            const target = type === 'tw' ? 'Japanese' : 'Traditional Chinese';
            
            // UI
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg-group ${type === 'tw' ? 'msg-me' : 'msg-other'}`;
            msgDiv.innerHTML = `<div class="label">${type === 'tw'?'You':'Guest'}</div><div class="result-text typing">...</div><div class="original-text">${text}</div>`;
            els.screen.appendChild(msgDiv);
            els.screen.scrollTop = els.screen.scrollHeight;
            const resEl = msgDiv.querySelector('.result-text');

            try {
                const result = await model.generateContentStream(`Translate to ${target}: "${text}"`);
                let fullText = "";
                resEl.innerText = "";
                for await (const chunk of result.stream) {
                    const t = chunk.text();
                    fullText += t;
                    resEl.innerText += t;
                    els.screen.scrollTop = els.screen.scrollHeight;
                }
                resEl.classList.remove('typing');
                
                // TTS
                const u = new SpeechSynthesisUtterance(fullText);
                u.lang = type === 'tw' ? 'ja-JP' : 'zh-TW';
                window.speechSynthesis.speak(u);

            } catch (e) {
                resEl.innerText = "Error";
                if(e.message.includes("404")) resEl.innerText = "Model 404 (Check Key)";
            }
        }

        // --- Ë™ûÈü≥Ëæ®Ë≠ò (Èô§ÈåØÂº∑ÂåñÁâà) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        if (!SpeechRecognition) {
            showError("ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏çÊîØÊè¥Ë™ûÈü≥Ëæ®Ë≠ò (Ë´ã‰ΩøÁî® Chrome/Safari)");
        }

        function setupBtn(id, lang, type) {
            const btn = document.getElementById(id);
            let recognition;
            let isHolding = false;

            const start = (e) => {
                e.preventDefault(); // Èò≤Ê≠¢ÊâãÊ©ü‰∏äÂêåÊôÇËß∏Áôº mouse/touch
                if (isHolding) return;
                
                els.errorDisplay.style.display = 'none'; // Ê∏ÖÈô§ËàäÈåØË™§
                isHolding = true;
                btn.classList.add('active');
                
                if (navigator.vibrate) navigator.vibrate(50);

                recognition = new SpeechRecognition();
                recognition.lang = lang;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    els.status.innerText = "üé§ Ê≠£Âú®ËÅÜËÅΩ...";
                    els.status.style.color = "#ffeb3b";
                };

                recognition.onerror = (event) => {
                    let msg = `ÈåØË™§: ${event.error}`;
                    if (event.error === 'not-allowed') msg = "‚ùå È∫•ÂÖãÈ¢®Ê¨äÈôêË¢´ÊãíÁµï„ÄÇË´ãÊ™¢Êü•ÁÄèË¶ΩÂô®Ë®≠ÂÆö„ÄÇ";
                    if (event.error === 'network') msg = "‚ùå Á∂≤Ë∑ØÈÄ£Á∑öÂïèÈ°å (Web Speech API ÈúÄË¶ÅÈÄ£Á∂≤)";
                    if (event.error === 'no-speech') msg = "‚ö†Ô∏è Ê≤íËÅΩÂà∞ËÅ≤Èü≥ÔºåË´ãÂÜçË©¶‰∏ÄÊ¨°";
                    
                    showError(msg);
                    els.status.innerText = "ÈåØË™§";
                };

                recognition.onend = () => {
                    if (isHolding) { // Â¶ÇÊûúÈÇÑÊåâËëó‰ΩÜÊñ∑‰∫Ü
                         // ÂèØÈÅ∏ÊìáËá™ÂãïÈáçÂïüÔºå‰ΩÜÁ∞°ÂñÆËµ∑Ë¶ãÂÖà‰∏çÂÅö
                    }
                };

                recognition.onresult = (event) => {
                    const text = event.results[0][0].transcript;
                    if (text) translate(text, type);
                };

                try {
                    recognition.start();
                } catch (e) {
                    console.error(e);
                }
            };

            const end = (e) => {
                e.preventDefault();
                if (!isHolding) return;
                isHolding = false;
                btn.classList.remove('active');
                if (recognition) {
                    recognition.stop();
                    els.status.innerText = "Gemini Ready";
                    els.status.style.color = "#888";
                }
            };

            btn.addEventListener('mousedown', start);
            btn.addEventListener('touchstart', start);
            btn.addEventListener('mouseup', end);
            btn.addEventListener('touchend', end);
            btn.addEventListener('mouseleave', end);
        }

        function showError(msg) {
            els.errorDisplay.innerText = msg;
            els.errorDisplay.style.display = 'block';
            console.error(msg);
        }

        setupBtn('btnTW', 'cmn-Hant-TW', 'tw');
        setupBtn('btnJP', 'ja-JP', 'jp');

    </script>
</body>
</html>