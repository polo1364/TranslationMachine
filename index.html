<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini 2.5 æ¥µé€Ÿæ„è­¯æ©Ÿ</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        :root {
            --primary: #4285f4;
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #1f1f1f;
            --gray: #757575;
            --error: #b00020;
            --overlay: rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: var(--text);
            overflow: hidden;
        }

        /* --- é ‚éƒ¨å°èˆª --- */
        .navbar {
            background: var(--card);
            padding: 12px 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between; /* å·¦å³åˆ†é–‹ */
            align-items: center;
            z-index: 10;
            flex-shrink: 0;
        }

        .title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* è¨­å®šæŒ‰éˆ• (é½’è¼ª) */
        .btn-setting {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            color: var(--gray);
            transition: transform 0.3s;
        }
        .btn-setting:hover { transform: rotate(90deg); color: var(--primary); }

        /* --- æ¨¡æ…‹è¦–çª— (Modal) --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--overlay);
            z-index: 1000;
            display: none; /* é è¨­éš±è— */
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.show { display: flex; }

        .modal-content {
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-title { margin: 0 0 15px 0; font-size: 20px; color: #333; }
        .modal-desc { font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.5; }

        .api-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
            background: #f9f9f9;
        }
        .api-input:focus { border-color: var(--primary); outline: none; background: #fff; }

        .btn-save {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s;
        }
        .btn-save:active { transform: scale(0.98); }

        /* --- ä¸»å…§å®¹å€ --- */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px;
            gap: 12px;
            overflow-y: auto;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .input-card { flex: 0 0 auto; min-height: 180px; }
        .output-card { flex: 1; background-color: #f8fbff; overflow: hidden; }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee;
        }

        select {
            border: none; background: transparent; font-size: 15px; font-weight: 600;
            color: var(--primary); outline: none;
        }

        textarea {
            width: 100%; border: none; resize: none; font-size: 18px; line-height: 1.5;
            outline: none; background: transparent; padding: 0; font-family: inherit; flex: 1;
        }

        .output-area {
            flex: 1; width: 100%; overflow-y: auto; white-space: pre-wrap;
            font-size: 18px; line-height: 1.6; color: #202124;
        }

        #imagePreviewContainer { display: none; margin-top: 10px; position: relative; width: fit-content; }
        #imagePreview { height: 100px; border-radius: 8px; border: 2px solid var(--primary); display: block; }
        #removeImgBtn {
            position: absolute; top: -8px; right: -8px; background: var(--error);
            color: white; border-radius: 50%; width: 24px; height: 24px;
            text-align: center; line-height: 24px; font-size: 14px; cursor: pointer;
        }

        .controls { display: flex; justify-content: flex-end; gap: 12px; margin-top: 10px; align-items: center; }

        .btn-icon {
            width: 48px; height: 48px; border-radius: 50%; border: none;
            background-color: #f1f3f4; color: #5f6368; font-size: 22px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .btn-icon:active { transform: scale(0.92); }
        .btn-mic.listening { background-color: #ea4335; color: white; animation: pulse 1.5s infinite; }
        .btn-camera, .btn-speak { color: var(--primary); background: #e8f0fe; }
        .btn-stop { color: #d93025; background: #fce8e6; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        #fileInput { display: none; }
        .status-text { font-size: 12px; color: var(--gray); margin-right: auto; }
        .cursor::after { content: 'â–‹'; color: var(--primary); animation: blink 1s infinite; margin-left: 2px; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="title">âš¡ Gemini 2.5 ç¿»è­¯æ©Ÿ</div>
        <button id="settingBtn" class="btn-setting" title="è¨­å®š API Key">âš™ï¸</button>
    </div>

    <div id="keyModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">è¨­å®š API Key</h3>
            <p class="modal-desc">è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key<br>(åƒ…å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­)</p>
            <input type="password" id="modalKeyInput" class="api-input" placeholder="è²¼ä¸Š API Key...">
            <button id="saveKeyBtn" class="btn-save">å„²å­˜ä¸¦é–‹å§‹</button>
        </div>
    </div>

    <div class="main-container">
        <div class="card input-card">
            <div class="card-header">
                <select id="inputLang">
                    <option value="auto">ğŸŒ è‡ªå‹•åµæ¸¬ (é è¨­ä¸­æ–‡)</option>
                    <option value="zh-TW">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</option>
                    <option value="en-US">ğŸ‡ºğŸ‡¸ è‹±æ–‡ (English)</option>
                    <option value="ja-JP">ğŸ‡¯ğŸ‡µ æ—¥æ–‡ (æ—¥æœ¬èª)</option>
                    <option value="ko-KR">ğŸ‡°ğŸ‡· éŸ“æ–‡ (í•œêµ­ì–´)</option>
                </select>
                <span id="statusText" class="status-text">å°±ç·’</span>
            </div>

            <textarea id="inputText" placeholder="è¼¸å…¥æ–‡å­—ï¼Œæˆ–é»æ“Šç›¸æ©Ÿ/éº¥å…‹é¢¨..."></textarea>
            
            <div id="imagePreviewContainer">
                <img id="imagePreview" alt="Preview">
                <div id="removeImgBtn">âœ•</div>
            </div>

            <div class="controls">
                <input type="file" id="fileInput" accept="image/*" capture="environment">
                <button id="cameraBtn" class="btn-icon btn-camera" title="æ‹ç…§ç¿»è­¯">ğŸ“·</button>
                <button id="micBtn" class="btn-icon btn-mic" title="èªéŸ³è¼¸å…¥">ğŸ¤</button>
            </div>
        </div>

        <div class="card output-card">
            <div class="card-header">
                <select id="targetLang">
                    <option value="Traditional Chinese (Taiwan)">ğŸ‡¹ğŸ‡¼ ç¿»æˆï¼šç¹é«”ä¸­æ–‡</option>
                    <option value="Japanese">ğŸ‡¯ğŸ‡µ ç¿»æˆï¼šæ—¥æ–‡ (æ•¬èª)</option>
                    <option value="English">ğŸ‡ºğŸ‡¸ ç¿»æˆï¼šè‹±æ–‡</option>
                    <option value="Korean">ğŸ‡°ğŸ‡· ç¿»æˆï¼šéŸ“æ–‡</option>
                </select>
            </div>

            <div id="outputText" class="output-area"></div>

            <div class="controls" style="margin-top:auto;">
                <button id="stopBtn" class="btn-icon btn-stop" title="åœæ­¢æœ—è®€">â¹ï¸</button>
                <button id="speakBtn" class="btn-icon btn-speak" title="æœ—è®€çµæœ">ğŸ”Š</button>
                <button id="copyBtn" class="btn-icon" title="è¤‡è£½æ–‡å­—">ğŸ“‹</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- DOM å…ƒç´  ---
        const els = {
            inputLang: document.getElementById('inputLang'),
            targetLang: document.getElementById('targetLang'),
            input: document.getElementById('inputText'),
            output: document.getElementById('outputText'),
            status: document.getElementById('statusText'),
            micBtn: document.getElementById('micBtn'),
            cameraBtn: document.getElementById('cameraBtn'),
            fileInput: document.getElementById('fileInput'),
            speakBtn: document.getElementById('speakBtn'),
            stopBtn: document.getElementById('stopBtn'),
            copyBtn: document.getElementById('copyBtn'),
            imgContainer: document.getElementById('imagePreviewContainer'),
            imgPreview: document.getElementById('imagePreview'),
            removeImg: document.getElementById('removeImgBtn'),
            // Modal ç›¸é—œ
            modal: document.getElementById('keyModal'),
            modalInput: document.getElementById('modalKeyInput'),
            saveBtn: document.getElementById('saveKeyBtn'),
            settingBtn: document.getElementById('settingBtn')
        };

        let genAI, model;
        let currentImagePart = null;
        let debounceTimer;

        // --- API Key ç®¡ç†é‚è¼¯ ---
        function checkAndInitKey() {
            const savedKey = localStorage.getItem('gemini_api_key_v2');
            if (savedKey) {
                els.modalInput.value = savedKey; // é å¡«
                initModel(savedKey);
                els.modal.classList.remove('show'); // æœ‰ Key å°±éš±è—
            } else {
                els.modal.classList.add('show'); // æ²’ Key å°±é¡¯ç¤º
            }
        }

        function initModel(key) {
            if (!key) return false;
            try {
                genAI = new GoogleGenerativeAI(key);
                return true;
            } catch (e) {
                console.error("Init failed", e);
                return false;
            }
        }

        // å„²å­˜æŒ‰éˆ•
        els.saveBtn.addEventListener('click', () => {
            const key = els.modalInput.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key_v2', key);
                initModel(key);
                els.modal.classList.remove('show');
                els.status.innerText = "API Key å·²å„²å­˜";
            } else {
                alert("è«‹è¼¸å…¥ API Key");
            }
        });

        // è¨­å®šæŒ‰éˆ• (æ‰“é–‹ Modal)
        els.settingBtn.addEventListener('click', () => {
            els.modal.classList.add('show');
        });

        // é»æ“ŠèƒŒæ™¯é—œé–‰ Modal (å¦‚æœæœ‰ Key çš„è©±)
        els.modal.addEventListener('click', (e) => {
            if (e.target === els.modal && localStorage.getItem('gemini_api_key_v2')) {
                els.modal.classList.remove('show');
            }
        });

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥
        checkAndInitKey();


        // --- æ ¸å¿ƒç¿»è­¯åŠŸèƒ½ (Gemini 2.5) ---
        async function fileToGenerativePart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve({ inlineData: { data: base64Data, mimeType: file.type } });
                };
                reader.readAsDataURL(file);
            });
        }

        async function runTranslation() {
            const text = els.input.value.trim();
            if (!text && !currentImagePart) return;

            // ç¢ºä¿æœ‰åˆå§‹åŒ–
            if (!genAI) {
                els.modal.classList.add('show'); // æ²’åˆå§‹åŒ–å°±å½ˆçª—
                return;
            }

            window.speechSynthesis.cancel(); // åœæ­¢èˆŠèªéŸ³

            const target = els.targetLang.value;
            els.status.innerText = "Gemini 2.5 æ€è€ƒä¸­...";
            els.output.innerText = "";
            els.output.classList.add('cursor');

            let prompt = "";
            let inputParts = [];

            if (currentImagePart) {
                prompt = `è§’è‰²ï¼šæ—…éŠåŠ©æ‰‹ã€‚ä»»å‹™ï¼šåˆ†æåœ–ç‰‡ä¸¦æ„è­¯æˆã€${target}ã€‘ã€‚è¦å‰‡ï¼š1.åˆ—å‡ºé‡é»ã€‚2.ä¿æŒæ’ç‰ˆã€‚3.åƒè€ƒæ–‡å­—ï¼š"${text}"ã€‚`;
                inputParts = [prompt, currentImagePart];
            } else {
                prompt = `è§’è‰²ï¼šå³æ™‚å£è­¯å“¡ã€‚ä»»å‹™ï¼šå°‡ "${text}" æ„è­¯æˆã€${target}ã€‘ã€‚è¦å‰‡ï¼šè‡ªç„¶å£èªã€ä¸é€å­—ç¿»ã€‚`;
                inputParts = [prompt];
            }

            try {
                // ä½¿ç”¨ Gemini 2.5 Flash
                model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
                const result = await model.generateContentStream(inputParts);

                for await (const chunk of result.stream) {
                    els.output.innerText += chunk.text();
                    els.output.scrollTop = els.output.scrollHeight;
                }
                els.status.innerText = "å®Œæˆ";
            } catch (error) {
                console.error(error);
                els.output.innerText = "âŒ éŒ¯èª¤: " + error.message;
                if(error.message.includes("404")) els.output.innerText += "\n(è«‹æª¢æŸ¥ API Key æ¬Šé™)";
                els.status.innerText = "å¤±æ•—";
            } finally {
                els.output.classList.remove('cursor');
            }
        }

        // --- äº‹ä»¶ç›£è½ ---
        els.input.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            if (!els.input.value && !currentImagePart) {
                els.output.innerText = ""; els.status.innerText = "å°±ç·’"; return;
            }
            debounceTimer = setTimeout(runTranslation, 600);
        });

        els.targetLang.addEventListener('change', () => runTranslation());

        els.cameraBtn.addEventListener('click', () => els.fileInput.click());
        els.fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            els.status.innerText = "è™•ç†åœ–ç‰‡ä¸­...";
            els.imgPreview.src = URL.createObjectURL(file);
            els.imgContainer.style.display = 'block';
            currentImagePart = await fileToGenerativePart(file);
            runTranslation();
        });

        els.removeImg.addEventListener('click', () => {
            els.fileInput.value = ''; currentImagePart = null;
            els.imgContainer.style.display = 'none'; els.output.innerText = "";
            els.status.innerText = "åœ–ç‰‡å·²ç§»é™¤";
        });

        // èªéŸ³è¾¨è­˜
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.interimResults = true;
            els.micBtn.addEventListener('click', () => {
                if (els.micBtn.classList.contains('listening')) recognition.stop();
                else {
                    let lang = els.inputLang.value;
                    if (lang === 'auto') lang = 'zh-TW';
                    recognition.lang = lang; recognition.start();
                }
            });
            recognition.onstart = () => { els.micBtn.classList.add('listening'); els.status.innerText = "ğŸ¤ è†è½ä¸­..."; els.input.placeholder = "è«‹é–‹å§‹èªªè©±..."; };
            recognition.onend = () => { els.micBtn.classList.remove('listening'); els.status.innerText = "èªéŸ³çµæŸ"; els.input.placeholder = "è¼¸å…¥æ–‡å­—..."; };
            recognition.onresult = (e) => {
                let transcript = '';
                for (let i = e.resultIndex; i < e.results.length; ++i) transcript += e.results[i][0].transcript;
                els.input.value = transcript; els.input.dispatchEvent(new Event('input'));
            };
        } else { els.micBtn.style.display = 'none'; }

        // æœ—è®€èˆ‡åœæ­¢
        els.speakBtn.addEventListener('click', () => {
            const text = els.output.innerText; if (!text) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            const target = els.targetLang.value;
            if (target.includes("Japan")) utterance.lang = "ja-JP";
            else if (target.includes("English")) utterance.lang = "en-US";
            else if (target.includes("Korean")) utterance.lang = "ko-KR";
            else utterance.lang = "zh-TW";
            window.speechSynthesis.speak(utterance);
        });

        els.stopBtn.addEventListener('click', () => {
            window.speechSynthesis.cancel();
            els.status.innerText = "å·²åœæ­¢æœ—è®€";
        });

        els.copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(els.output.innerText);
            els.status.innerText = "å·²è¤‡è£½";
        });

    </script>
</body>
</html>