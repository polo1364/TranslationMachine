<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini 2.5 å°ˆæ¥­å£è­¯æ©Ÿ</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        :root {
            --bg-color: #121212;
            --btn-me: #2d7aff;    /* è—è‰² */
            --btn-other: #ff453a; /* ç´…è‰² */
            --text-color: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
            color: var(--text-color);
            overflow: hidden;
            touch-action: manipulation;
        }

        /* é ‚éƒ¨å°èˆª */
        .navbar {
            padding: 10px 15px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(30,30,30,0.8); backdrop-filter: blur(10px); z-index: 10;
        }
        .status-badge {
            font-size: 12px; padding: 4px 8px; border-radius: 4px;
            background: #333; color: #888; transition: 0.3s;
        }
        .status-badge.active { background: #4caf50; color: #fff; }

        /* è¢å¹•é¡¯ç¤ºå€ */
        .screen {
            flex: 1; padding: 20px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
            scroll-behavior: smooth;
        }

        /* å°è©±æ°£æ³¡ */
        .msg-group {
            display: flex; flex-direction: column; gap: 6px;
            opacity: 0; animation: fadeIn 0.3s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        .label { font-size: 12px; color: #666; letter-spacing: 1px; text-transform: uppercase; }
        
        .result-text {
            font-size: 28px; font-weight: 700; line-height: 1.3;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .original-text { font-size: 16px; color: #888; }

        /* æˆ‘æ–¹ (ä¸­æ–‡ -> æ—¥æ–‡) */
        .msg-me { align-items: flex-end; text-align: right; }
        .msg-me .result-text { color: var(--btn-other); }
        .msg-me .label { color: var(--btn-me); }

        /* å°æ–¹ (æ—¥æ–‡ -> ä¸­æ–‡) */
        .msg-other { align-items: flex-start; text-align: left; }
        .msg-other .result-text { color: var(--btn-me); }
        .msg-other .label { color: var(--btn-other); }

        /* åº•éƒ¨æŒ‰éˆ•å€ (ä»¿å¯¦é«”æ©Ÿ) */
        .controls {
            height: 240px;
            background: #1c1c1e;
            border-top: 1px solid #333;
            display: flex; justify-content: center; align-items: center; gap: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            padding-bottom: 20px;
        }

        .push-btn {
            width: 130px; height: 130px;
            border-radius: 50%;
            border: 4px solid #333;
            background: #2c2c2e;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            cursor: pointer; position: relative;
            transition: transform 0.1s, border-color 0.2s;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .push-btn:active, .push-btn.active { transform: scale(0.92); border-color: #fff; }

        .btn-tw { background: radial-gradient(circle, #2d7aff 0%, #0040dd 100%); }
        .btn-jp { background: radial-gradient(circle, #ff453a 0%, #d70015 100%); }

        .lang-code { font-size: 32px; font-weight: 900; color: #fff; }
        .lang-name { font-size: 14px; color: rgba(255,255,255,0.8); margin-top: 4px; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #2c2c2e; padding: 25px; border-radius: 20px;
            width: 85%; max-width: 350px; text-align: center; border: 1px solid #444;
        }
        .api-input {
            width: 100%; padding: 12px; border: 1px solid #555; border-radius: 10px;
            margin: 15px 0; font-size: 16px; background: #1c1c1e; color: #fff; box-sizing: border-box;
        }
        .btn-save {
            background: var(--btn-me); color: white; border: none; padding: 12px;
            width: 100%; border-radius: 10px; font-size: 16px; font-weight: bold;
        }

        /* æ¸¸æ¨™ */
        .typing::after { content: 'â–‹'; animation: blink 1s infinite; color: #fff; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div class="navbar">
        <div style="font-weight:bold; font-size:16px;">Gemini 2.5 å£è­¯æ©Ÿ</div>
        <div id="statusBadge" class="status-badge">ç­‰å¾…é€£ç·š</div>
        <button id="settingBtn" style="background:none; border:none; font-size:20px; cursor:pointer;">âš™ï¸</button>
    </div>

    <div id="screen" class="screen">
        <div style="text-align:center; color:#444; margin-top:auto; font-size:14px;">
            æŒ‰ä½èªªè©± (Push to Talk)
        </div>
    </div>

    <div class="controls">
        <div id="btnJP" class="push-btn btn-jp">
            <div class="lang-code">JP</div>
            <div class="lang-name">å°æ–¹ (æ—¥æ–‡)</div>
        </div>
        <div id="btnTW" class="push-btn btn-tw">
            <div class="lang-code">TW</div>
            <div class="lang-name">æˆ‘ (ä¸­æ–‡)</div>
        </div>
    </div>

    <div id="keyModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:#fff; margin:0;">ğŸ”‘ è¨­å®š Key</h3>
            <p style="color:#aaa; font-size:13px; margin-top:5px;">è«‹è¼¸å…¥ API Key (å°‡ä½¿ç”¨ Gemini 2.5)</p>
            <input type="password" id="apiKeyInput" class="api-input" placeholder="è²¼ä¸Š API Key">
            <button id="saveKeyBtn" class="btn-save">ç¢ºèª</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const els = {
            screen: document.getElementById('screen'),
            btnTW: document.getElementById('btnTW'),
            btnJP: document.getElementById('btnJP'),
            status: document.getElementById('statusBadge'),
            modal: document.getElementById('keyModal'),
            input: document.getElementById('apiKeyInput'),
            saveBtn: document.getElementById('saveKeyBtn'),
            settingBtn: document.getElementById('settingBtn')
        };

        let genAI, model;
        let isHolding = false;
        let finalTranscript = "";

        // --- åˆå§‹åŒ– (é–å®š Gemini 2.5 Flash) ---
        const savedKey = localStorage.getItem('gemini_api_key_pro');
        if (savedKey) { els.input.value = savedKey; initAI(savedKey); }
        else { els.modal.style.display = 'flex'; }

        function initAI(key) {
            try {
                genAI = new GoogleGenerativeAI(key);
                
                // ğŸ”¥ ä¿®æ­£ï¼šå¼·åˆ¶ä½¿ç”¨ 2.5 Flash
                model = genAI.getGenerativeModel({ 
                    model: "gemini-2.5-flash", 
                    systemInstruction: "ä½ æ˜¯ä¸€å€‹å³æ™‚å£è­¯å“¡ã€‚è¦å‰‡ï¼š1. å°‡è¼¸å…¥ç¿»è­¯æˆç›®æ¨™èªè¨€ã€‚2. ç¿»è­¯å¿…é ˆã€é“åœ°ã€è‡ªç„¶ã€‘ã€‚3. ä¸­ç¿»æ—¥è«‹ç”¨é©ç•¶æ•¬èªã€‚4. æ—¥ç¿»ä¸­è«‹ç”¨å°ç£å£èªã€‚5. ä¸è§£é‡‹ï¼Œåªè¼¸å‡ºçµæœã€‚"
                });

                els.status.innerText = "Gemini 2.5 Ready";
                els.status.classList.add('active');
            } catch (e) {
                console.error(e);
                els.status.innerText = "Key Error";
            }
        }

        els.saveBtn.addEventListener('click', () => {
            const key = els.input.value.trim();
            if(key) {
                localStorage.setItem('gemini_api_key_pro', key);
                initAI(key);
                els.modal.style.display = 'none';
            }
        });
        els.settingBtn.addEventListener('click', () => els.modal.style.display = 'flex');

        // --- æ ¸å¿ƒé‚è¼¯ï¼šStreaming + TTS ---
        async function translateAndSpeak(text, type) {
            if (!model) { els.modal.style.display = 'flex'; return; }
            if (!text.trim()) return;

            // 1. UI é¡¯ç¤º
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg-group ${type === 'tw' ? 'msg-me' : 'msg-other'}`;
            msgDiv.innerHTML = `
                <div class="label">${type === 'tw' ? 'You' : 'Guest'}</div>
                <div class="result-text typing">...</div>
                <div class="original-text">${text}</div>
            `;
            els.screen.appendChild(msgDiv);
            els.screen.scrollTop = els.screen.scrollHeight;

            const resultTextEl = msgDiv.querySelector('.result-text');
            let fullTranslation = "";

            // 2. Prompt
            const target = type === 'tw' ? 'Japanese' : 'Traditional Chinese (Taiwan)';
            const prompt = `Translate to ${target}: "${text}"`;

            try {
                // 3. å‘¼å« Gemini 2.5
                const result = await model.generateContentStream(prompt);

                resultTextEl.innerText = ""; 
                
                for await (const chunk of result.stream) {
                    const chunkText = chunk.text();
                    fullTranslation += chunkText;
                    resultTextEl.innerText += chunkText;
                    els.screen.scrollTop = els.screen.scrollHeight;
                }
                
                resultTextEl.classList.remove('typing');

                // 4. æœ—è®€
                const speakLang = type === 'tw' ? 'ja-JP' : 'zh-TW';
                speak(fullTranslation, speakLang);

            } catch (error) {
                resultTextEl.innerText = "Error";
                console.error(error);
                // 404 éŒ¯èª¤æç¤º
                if(error.message.includes("404")) {
                     resultTextEl.innerText = "Model 404 (Check Key)";
                }
            }
        }

        // --- TTS ---
        function speak(text, lang) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = lang;
            u.rate = 1.0; 
            window.speechSynthesis.speak(u);
        }

        // --- èªéŸ³è¾¨è­˜ (Web Speech API) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) alert("è«‹ä½¿ç”¨ Chrome æˆ– Safari");

        function setupBtn(btn, langCode, type) {
            let recognition;

            const start = (e) => {
                e.preventDefault();
                if (isHolding) return;
                isHolding = true;
                btn.classList.add('active');
                if(navigator.vibrate) navigator.vibrate(50); // éœ‡å‹•å›é¥‹

                finalTranscript = "";
                recognition = new SpeechRecognition();
                recognition.lang = langCode;
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    els.status.innerText = "ğŸ¤ è†è½ä¸­...";
                    els.status.style.color = "#ffeb3b";
                };

                recognition.onresult = (event) => {
                    finalTranscript = event.results[0][0].transcript;
                };

                recognition.onerror = (e) => { console.error(e); };
                recognition.start();
            };

            const end = (e) => {
                e.preventDefault();
                if (!isHolding) return;
                isHolding = false;
                btn.classList.remove('active');
                
                if (recognition) {
                    recognition.stop();
                    els.status.innerText = "ç¿»è­¯ä¸­...";
                    els.status.style.color = "#4caf50";

                    setTimeout(() => {
                        if (finalTranscript) {
                            translateAndSpeak(finalTranscript, type);
                        } else {
                            els.status.innerText = "Gemini 2.5 Ready";
                            els.status.style.color = "#888";
                        }
                    }, 200);
                }
            };

            btn.addEventListener('mousedown', start);
            btn.addEventListener('touchstart', start);
            btn.addEventListener('mouseup', end);
            btn.addEventListener('touchend', end);
            btn.addEventListener('mouseleave', end);
        }

        setupBtn(els.btnTW, 'cmn-Hant-TW', 'tw');
        setupBtn(els.btnJP, 'ja-JP', 'jp');

    </script>
</body>
</html>